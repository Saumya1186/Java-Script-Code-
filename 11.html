<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockTrade Pro - Ultimate Trading Terminal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
         :root {
            --primary: #1a73e8;
            --success: #0f9d58;
            --danger: #db4437;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f7fa;
            --text-primary: #1a1a2e;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #a8b2d1;
            --border-color: #2d3748;
        }
        
        * {
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
        }
        
        .app-container {
            display: none;
        }
        
        .navbar-custom {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .sidebar {
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            height: calc(100vh - 56px);
            position: sticky;
            top: 56px;
            overflow-y: auto;
            padding: 20px;
        }
        
        .ticker-tape {
            background: var(--bg-primary);
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
            white-space: nowrap;
        }
        
        .ticker-content {
            display: inline-block;
            animation: scroll 40s linear infinite;
        }
        
        @keyframes scroll {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-50%);
            }
        }
        
        .ticker-item {
            display: inline-block;
            margin: 0 25px;
            font-size: 0.9rem;
        }
        
        .stock-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .stock-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .price-up {
            color: var(--success) !important;
        }
        
        .price-down {
            color: var(--danger) !important;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        canvas {
            width: 100%;
            height: 350px;
        }
        
        .balance-card {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .heatmap-cell {
            display: inline-block;
            width: 85px;
            height: 85px;
            margin: 4px;
            border-radius: 6px;
            text-align: center;
            padding-top: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .alert-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .transaction-item {
            border-left: 4px solid var(--primary);
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-item:hover {
            background: var(--bg-secondary);
        }
        
        .kbd-shortcut {
            background: var(--bg-secondary);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.75rem;
            border: 1px solid var(--border-color);
        }
    </style>
</head>

<body>

    <!-- Login -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="p-4 text-center bg-primary text-white">
                <h3>üìà StockTrade Pro</h3>
                <p class="mb-0">Unified Advanced Terminal</p>
            </div>
            <div class="p-4">
                <form id="loginForm">
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" class="form-control" id="loginEmail" value="user@demo.com" required>
                    </div>
                    <div class="mb-3">
                        <label>Password</label>
                        <input type="password" class="form-control" id="loginPassword" value="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Access Terminal</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appContainer" class="app-container">
        <div class="ticker-tape">
            <div class="ticker-content" id="tickerContent"></div>
        </div>

        <nav class="navbar navbar-expand-lg navbar-custom">
            <div class="container-fluid">
                <span class="navbar-brand fw-bold">üìà StockTrade Pro</span>
                <div class="d-flex align-items-center">
                    <span class="me-3">Theme: <span style="cursor:pointer;" onclick="toggleTheme()" id="themeIcon">üåô</span></span>
                    <div class="position-relative me-3" style="cursor:pointer;" onclick="showSection('alerts')">
                        üîî <span class="alert-badge" id="alertCount">0</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="location.reload()">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-2 sidebar d-none d-md-block">
                    <div class="d-grid gap-1">
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('dashboard')">üè† Dashboard</button>
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('search')">üîç Search & Screener</button>
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('portfolio')">üíº My Portfolio</button>
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('analytics')">üìä Analytics</button>
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('history')">üìú Trade History</button>
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('orders')">üìã Open Orders</button>
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('compare')">‚öñÔ∏è Compare Stocks</button>
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('heatmap')">üå°Ô∏è Heatmap</button>
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('social')">üí¨ Social Feed</button>
                        <button class="btn btn-sm text-start btn-outline-primary border-0" onclick="showSection('bot')">ü§ñ Trading Bot</button>
                    </div>
                    <hr>
                    <div class="small text-muted">
                        <div><span class="kbd-shortcut">B</span> Buy Order</div>
                        <div><span class="kbd-shortcut">D</span> Dashboard</div>
                    </div>
                </div>

                <!-- Content -->
                <div class="col-md-10 p-4">

                    <!-- Dashboard -->
                    <div id="dashboardSection" class="content-section">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="balance-card">
                                    <small>Total Portfolio Value</small>
                                    <h2 id="totalBalance">$50,000.00</h2>
                                    <div class="d-flex justify-content-between mt-3">
                                        <span>Cash: <br><strong id="cashBalance">$50,000</strong></span>
                                        <span>Invested: <br><strong id="investedBalance">$0</strong></span>
                                    </div>
                                    <div class="mt-2 small">Daily P&L: <span id="dailyPL">+$0.00</span></div>
                                </div>
                                <div class="chart-container" style="max-height: 250px; overflow-y: auto;">
                                    <h6>Live News Feed</h6>
                                    <div id="newsFeed" class="small"></div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="chart-container">
                                    <div class="d-flex justify-content-between mb-2">
                                        <h5 id="chartTitle">Market View: AAPL</h5>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="setChartType('line')">Line</button>
                                            <button class="btn btn-outline-primary" onclick="setChartType('candlestick')">Candle</button>
                                            <button class="btn btn-outline-primary" onclick="setChartType('area')">Area</button>
                                        </div>
                                    </div>
                                    <canvas id="mainChart"></canvas>
                                    <div class="mt-2 small">
                                        <input type="checkbox" id="checkMA" onchange="drawChart()"> MA(20)
                                        <input type="checkbox" id="checkEMA" onchange="drawChart()" class="ms-2"> EMA(10)
                                        <input type="checkbox" id="checkBB" onchange="drawChart()" class="ms-2"> Bollinger
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="topStocksGrid"></div>
                    </div>

                    <!-- Search / Screener -->
                    <div id="searchSection" class="content-section" style="display:none;">
                        <h3>Screener & Filter</h3>
                        <div class="stock-card">
                            <div class="row g-2">
                                <div class="col-md-4 position-relative">
                                    <input type="text" class="form-control" id="stockSearchInput" placeholder="Search symbol...">
                                    <div id="searchDropdown" class="search-results" style="display:none;"></div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="filterSector">
                                        <option value="All">All Sectors</option>
                                        <option value="Technology">Technology</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Consumer">Consumer</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="filterPerf">
                                        <option value="all">Any Performance</option>
                                        <option value="gainers">Top Gainers</option>
                                        <option value="losers">Top Losers</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" onclick="applyScreener()">Apply</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3" id="screenerResults"></div>
                    </div>

                    <!-- Portfolio -->
                    <div id="portfolioSection" class="content-section" style="display:none;">
                        <div class="d-flex justify-content-between">
                            <h3>My Holdings</h3>
                            <button class="btn btn-sm btn-success" onclick="exportCSV()">üì• Export CSV</button>
                        </div>
                        <div id="portfolioList" class="mt-3"></div>
                    </div>

                    <!-- History -->
                    <div id="historySection" class="content-section" style="display:none;">
                        <h3>Trade History</h3>
                        <div id="historyLog"></div>
                    </div>

                    <!-- Open Orders -->
                    <div id="ordersSection" class="content-section" style="display:none;">
                        <h3>Active Limit/Stop Orders</h3>
                        <table class="table bg-white rounded shadow-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="openOrdersList"></tbody>
                        </table>
                    </div>

                    <!-- Compare -->
                    <div id="compareSection" class="content-section" style="display:none;">
                        <h3>Compare Stocks</h3>
                        <div class="stock-card" id="compareSelector"></div>
                        <div id="compareTable" class="mt-3"></div>
                    </div>

                    <!-- Heatmap -->
                    <div id="heatmapSection" class="content-section" style="display:none;">
                        <h3>Market Heatmap</h3>
                        <div id="heatmapGrid" class="text-center p-4 bg-white rounded shadow-sm"></div>
                    </div>

                    <!-- Social -->
                    <div id="socialSection" class="content-section" style="display:none;">
                        <div class="row">
                            <div class="col-md-8">
                                <h3>Community Feed</h3>
                                <div id="socialFeed"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="stock-card">
                                    <h6>Post Update</h6>
                                    <textarea id="postContent" class="form-control mb-2" rows="3" placeholder="What's your trade?"></textarea>
                                    <button class="btn btn-primary w-100" onclick="addPost()">Post</button>
                                </div>
                                <div class="stock-card mt-3">
                                    <h6>Leaderboard</h6>
                                    <div id="leaderboard" class="small"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trading Bot -->
                    <div id="botSection" class="content-section" style="display:none;">
                        <h3>Algorithmic Trading Bot</h3>
                        <div class="stock-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5>Status: <span id="botStatusBadge" class="badge bg-danger">OFFLINE</span></h5>
                                <button id="botToggleBtn" class="btn btn-success" onclick="toggleBot()">Start Bot</button>
                            </div>
                            <hr>
                            <label>Strategy</label>
                            <select class="form-select mb-3" id="botStrategy">
                                <option value="ma">MA Crossover (Conservative)</option>
                                <option value="rsi">RSI Mean Reversion (Moderate)</option>
                                <option value="momentum">Momentum Chase (Aggressive)</option>
                            </select>
                            <label>Max Budget Per Trade ($)</label>
                            <input type="number" id="botBudget" class="form-control mb-3" value="1000">
                            <p class="text-muted small">The bot will automatically execute market orders based on technical indicators.</p>
                        </div>
                    </div>

                    <!-- Alerts -->
                    <div id="alertsSection" class="content-section" style="display:none;">
                        <h3>Price Alerts</h3>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="stock-card">
                                    <h6>Set Price Alert</h6>
                                    <input type="text" id="alertSym" class="form-control mb-2" placeholder="Symbol (e.g. TSLA)">
                                    <input type="number" id="alertPrice" class="form-control mb-2" placeholder="Target Price">
                                    <select id="alertType" class="form-select mb-2">
                                        <option value="above">Price Above</option>
                                        <option value="below">Price Below</option>
                                    </select>
                                    <button class="btn btn-primary w-100" onclick="setAlert()">Add Alert</button>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div id="activeAlerts" class="stock-card"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div class="modal fade" id="tradeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-light">
                <div class="modal-header border-0">
                    <h5 id="modalSym">AAPL</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <h2 id="modalPrice">$0.00</h2>
                        <span id="modalChange">0.00%</span>
                    </div>
                    <div class="mb-3">
                        <label>Order Type</label>
                        <select class="form-select" id="orderType" onchange="toggleLimitInput()">
                            <option value="market">Market Order</option>
                            <option value="limit">Limit Order</option>
                            <option value="stop">Stop-Loss Order</option>
                        </select>
                    </div>
                    <div class="mb-3" id="limitInputDiv" style="display:none;">
                        <label>Trigger Price</label>
                        <input type="number" id="orderTriggerPrice" class="form-control" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label>Quantity</label>
                        <input type="number" id="orderQty" class="form-control" value="1" min="1">
                    </div>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total Estimate:</span>
                        <span id="orderTotal">$0.00</span>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-success flex-grow-1" onclick="submitTrade('buy')">BUY</button>
                    <button class="btn btn-danger flex-grow-1" onclick="submitTrade('sell')">SELL</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Data Definitions ---
        let user = {
            cash: 50000,
            portfolio: {}, // { AAPL: { qty: 10, avgPrice: 150 } }
            history: [],
            orders: [],
            alerts: [],
            posts: [{
                user: "TradeWhiz",
                text: "Bullish on NVDA earnings next week!",
                time: "2m ago"
            }, {
                user: "StockPro",
                text: "Just closed my AAPL position with 15% profit.",
                time: "15m ago"
            }]
        };

        const stocks = [{
            symbol: 'AAPL',
            name: 'Apple Inc.',
            price: 175.20,
            change: 1.2,
            sector: 'Technology',
            history: []
        }, {
            symbol: 'MSFT',
            name: 'Microsoft',
            price: 390.45,
            change: 2.1,
            sector: 'Technology',
            history: []
        }, {
            symbol: 'GOOGL',
            name: 'Alphabet',
            price: 145.10,
            change: -0.5,
            sector: 'Technology',
            history: []
        }, {
            symbol: 'TSLA',
            name: 'Tesla Inc.',
            price: 210.30,
            change: -3.2,
            sector: 'Consumer',
            history: []
        }, {
            symbol: 'NVDA',
            name: 'NVIDIA',
            price: 620.20,
            change: 4.5,
            sector: 'Technology',
            history: []
        }, {
            symbol: 'JPM',
            name: 'JPMorgan',
            price: 168.40,
            change: 0.2,
            sector: 'Finance',
            history: []
        }, {
            symbol: 'AMZN',
            name: 'Amazon',
            price: 172.10,
            change: 0.8,
            sector: 'Consumer',
            history: []
        }];

        let activeSym = 'AAPL';
        let chartType = 'line';
        let botActive = false;
        const canvas = document.getElementById('mainChart');
        const ctx = canvas.getContext('2d');

        // Initial history generation
        stocks.forEach(s => {
            for (let i = 0; i < 60; i++) s.history.push(s.price + (Math.random() - 0.5) * 10);
        });

        // --- Initialization ---
        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            startSimulation();
            updateUI();
            showSection('dashboard');
        };

        function updateUI() {
            let invested = 0;
            Object.keys(user.portfolio).forEach(sym => {
                const s = stocks.find(x => x.symbol === sym);
                invested += user.portfolio[sym].qty * s.price;
            });

            document.getElementById('totalBalance').innerText = `$${(user.cash + invested).toLocaleString()}`;
            document.getElementById('cashBalance').innerText = `$${user.cash.toLocaleString()}`;
            document.getElementById('investedBalance').innerText = `$${invested.toLocaleString()}`;
            document.getElementById('alertCount').innerText = user.alerts.length;

            renderTicker();
            renderTopStocks();
            drawChart();
            renderPortfolio();
            renderOrders();
            renderHistory();
            renderHeatmap();
            renderSocial();
            renderCompareSelector();
        }

        // --- Market Simulation ---
        function startSimulation() {
            setInterval(() => {
                stocks.forEach(s => {
                    let move = (Math.random() - 0.5) * 1.5;
                    s.price += move;
                    s.change = ((move / s.price) * 100);
                    s.history.push(s.price);
                    if (s.history.length > 100) s.history.shift();
                });
                checkOrdersAndAlerts();
                if (botActive) runBotLogic();
                updateUI();
            }, 3000);

            // News Simulation
            setInterval(() => {
                const s = stocks[Math.floor(Math.random() * stocks.length)];
                addNews(`Market report: Unusual volume detected for ${s.symbol} in early trading.`);
            }, 20000);
        }

        function checkOrdersAndAlerts() {
            // Check Limit Orders
            user.orders.forEach((o, i) => {
                const s = stocks.find(x => x.symbol === o.sym);
                let triggered = false;
                if (o.type === 'limit') {
                    if (o.dir === 'buy' && s.price <= o.trigger) triggered = true;
                    if (o.dir === 'sell' && s.price >= o.trigger) triggered = true;
                } else if (o.type === 'stop') {
                    if (o.dir === 'buy' && s.price >= o.trigger) triggered = true;
                    if (o.dir === 'sell' && s.price <= o.trigger) triggered = true;
                }

                if (triggered) {
                    executeTrade(o.sym, o.dir, s.price, o.qty, o.type);
                    user.orders.splice(i, 1);
                }
            });

            // Check Alerts
            user.alerts.forEach((a, i) => {
                const s = stocks.find(x => x.symbol === a.sym);
                if ((a.type === 'above' && s.price >= a.price) || (a.type === 'below' && s.price <= a.price)) {
                    alert(`üö® Alert: ${a.sym} hit target price of $${a.price}`);
                    user.alerts.splice(i, 1);
                }
            });
        }

        // --- Charting Engine ---
        function setChartType(t) {
            chartType = t;
            drawChart();
        }

        function drawChart() {
            const s = stocks.find(x => x.symbol === activeSym);
            document.getElementById('chartTitle').innerText = `Market View: ${s.symbol}`;

            const w = canvas.clientWidth;
            const h = canvas.clientHeight;
            canvas.width = w;
            canvas.height = h;

            const data = s.history.slice(-40);
            const min = Math.min(...data) * 0.99;
            const max = Math.max(...data) * 1.01;
            const range = max - min;
            const stepX = w / (data.length - 1);

            ctx.clearRect(0, 0, w, h);

            // Draw Price
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = s.change >= 0 ? '#0f9d58' : '#db4437';

            data.forEach((v, i) => {
                let x = i * stepX;
                let y = h - ((v - min) / range * h);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            if (chartType === 'area') {
                ctx.lineTo((data.length - 1) * stepX, h);
                ctx.lineTo(0, h);
                ctx.fillStyle = s.change >= 0 ? 'rgba(15,157,88,0.1)' : 'rgba(219,68,55,0.1)';
                ctx.fill();
            }

            // Indicators
            if (document.getElementById('checkMA').checked) drawIndicator(data, 20, '#f4b400', min, range);
            if (document.getElementById('checkEMA').checked) drawIndicator(data, 10, '#4285f4', min, range);
            if (document.getElementById('checkBB').checked) drawBollinger(data, min, range);
        }

        function drawIndicator(data, period, color, min, range) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 1;
            const stepX = canvas.width / (data.length - 1);
            for (let i = period; i < data.length; i++) {
                let avg = data.slice(i - period, i).reduce((a, b) => a + b) / period;
                let x = i * stepX;
                let y = canvas.height - ((avg - min) / range * canvas.height);
                if (i === period) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function drawBollinger(data, min, range) {
            const period = 20;
            const stepX = canvas.width / (data.length - 1);
            ctx.fillStyle = 'rgba(0,0,0,0.05)';
            ctx.beginPath();
            let topPoints = [];
            let btmPoints = [];
            for (let i = period; i < data.length; i++) {
                let slice = data.slice(i - period, i);
                let avg = slice.reduce((a, b) => a + b) / period;
                let dev = 2; // Simulated SD
                topPoints.push({
                    x: i * stepX,
                    y: canvas.height - ((avg + dev - min) / range * canvas.height)
                });
                btmPoints.push({
                    x: i * stepX,
                    y: canvas.height - ((avg - dev - min) / range * canvas.height)
                });
            }
            if (!topPoints.length) return;
            ctx.moveTo(topPoints[0].x, topPoints[0].y);
            topPoints.forEach(p => ctx.lineTo(p.x, p.y));
            for (let i = btmPoints.length - 1; i >= 0; i--) ctx.lineTo(btmPoints[i].x, btmPoints[i].y);
            ctx.fill();
        }

        // --- Trading Logic ---
        function toggleLimitInput() {
            document.getElementById('limitInputDiv').style.display =
                document.getElementById('orderType').value === 'market' ? 'none' : 'block';
        }

        function openTradeModal(sym) {
            activeSym = sym;
            const s = stocks.find(x => x.symbol === sym);
            document.getElementById('modalSym').innerText = s.symbol;
            document.getElementById('modalPrice').innerText = `$${s.price.toFixed(2)}`;
            document.getElementById('modalChange').innerText = `${s.change.toFixed(2)}%`;
            document.getElementById('modalChange').className = s.change >= 0 ? 'price-up' : 'price-down';
            document.getElementById('orderTriggerPrice').value = s.price.toFixed(2);
            new bootstrap.Modal(document.getElementById('tradeModal')).show();
            updateTotal();
        }

        function updateTotal() {
            const qty = document.getElementById('orderQty').value;
            const s = stocks.find(x => x.symbol === activeSym);
            document.getElementById('orderTotal').innerText = `$${(qty * s.price).toFixed(2)}`;
        }
        document.getElementById('orderQty').oninput = updateTotal;

        function submitTrade(dir) {
            const type = document.getElementById('orderType').value;
            const qty = parseInt(document.getElementById('orderQty').value);
            const trigger = parseFloat(document.getElementById('orderTriggerPrice').value);
            const s = stocks.find(x => x.symbol === activeSym);

            if (type === 'market') {
                executeTrade(activeSym, dir, s.price, qty, 'market');
            } else {
                user.orders.push({
                    sym: activeSym,
                    dir,
                    type,
                    trigger,
                    qty
                });
                alert(`${type.toUpperCase()} order placed.`);
            }
            bootstrap.Modal.getInstance(document.getElementById('tradeModal')).hide();
            updateUI();
        }

        function executeTrade(sym, dir, price, qty, orderType) {
            const total = price * qty;
            if (dir === 'buy') {
                if (user.cash < total) return alert("Insufficient cash.");
                user.cash -= total;
                if (!user.portfolio[sym]) user.portfolio[sym] = {
                    qty: 0,
                    avgPrice: 0
                };
                const oldQty = user.portfolio[sym].qty;
                const oldAvg = user.portfolio[sym].avgPrice;
                user.portfolio[sym].avgPrice = ((oldAvg * oldQty) + total) / (oldQty + qty);
                user.portfolio[sym].qty += qty;
            } else {
                if (!user.portfolio[sym] || user.portfolio[sym].qty < qty) return alert("Insufficient shares.");
                user.cash += total;
                user.portfolio[sym].qty -= qty;
                if (user.portfolio[sym].qty === 0) delete user.portfolio[sym];
            }
            user.history.push({
                sym,
                dir,
                price,
                qty,
                time: new Date().toLocaleTimeString(),
                type: orderType
            });
            addNews(`Trade Executed: ${dir.toUpperCase()} ${qty} ${sym} @ $${price.toFixed(2)}`);
        }

        // --- Bot Logic ---
        function toggleBot() {
            botActive = !botActive;
            document.getElementById('botStatusBadge').innerText = botActive ? 'RUNNING' : 'OFFLINE';
            document.getElementById('botStatusBadge').className = botActive ? 'badge bg-success' : 'badge bg-danger';
            document.getElementById('botToggleBtn').innerText = botActive ? 'Stop Bot' : 'Start Bot';
            document.getElementById('botToggleBtn').className = botActive ? 'btn btn-danger' : 'btn btn-success';
        }

        function runBotLogic() {
            const strategy = document.getElementById('botStrategy').value;
            const budget = parseFloat(document.getElementById('botBudget').value);

            stocks.forEach(s => {
                const data = s.history.slice(-20);
                const ma = data.reduce((a, b) => a + b) / data.length;
                const price = s.price;

                if (strategy === 'ma') {
                    if (price < ma * 0.98 && user.cash >= budget) executeTrade(s.symbol, 'buy', price, Math.floor(budget / price), 'bot');
                    if (price > ma * 1.02 && user.portfolio[s.symbol]) executeTrade(s.symbol, 'sell', price, user.portfolio[s.symbol].qty, 'bot');
                }
            });
        }

        // --- Render Helpers ---
        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.getElementById(id + 'Section').style.display = 'block';
        }

        function renderTicker() {
            const html = stocks.map(s => `
                <span class="ticker-item">
                    <strong>${s.symbol}</strong> $${s.price.toFixed(2)} 
                    <span class="${s.change >= 0 ? 'price-up' : 'price-down'}">${s.change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(s.change).toFixed(2)}%</span>
                </span>
            `).join('');
            document.getElementById('tickerContent').innerHTML = html + html;
        }

        function renderTopStocks() {
            document.getElementById('topStocksGrid').innerHTML = stocks.map(s => `
                <div class="col-md-3">
                    <div class="stock-card" onclick="activeSym='${s.symbol}'; drawChart();">
                        <div class="d-flex justify-content-between"><strong>${s.symbol}</strong><small>${s.sector}</small></div>
                        <h4>$${s.price.toFixed(2)}</h4>
                        <div class="${s.change >= 0 ? 'price-up' : 'price-down'} small">${s.change >= 0 ? '+' : ''}${s.change.toFixed(2)}%</div>
                        <button class="btn btn-sm btn-primary w-100 mt-2" onclick="openTradeModal('${s.symbol}')">Trade</button>
                    </div>
                </div>
            `).join('');
        }

        function renderPortfolio() {
            const items = Object.keys(user.portfolio);
            document.getElementById('portfolioList').innerHTML = items.length ? items.map(sym => {
                const h = user.portfolio[sym];
                const s = stocks.find(x => x.symbol === sym);
                const pnl = (s.price - h.avgPrice) * h.qty;
                return `
                    <div class="stock-card mb-2">
                        <div class="row align-items-center">
                            <div class="col-3"><strong>${sym}</strong><br><small>${h.qty} shares</small></div>
                            <div class="col-3">Avg: $${h.avgPrice.toFixed(2)}</div>
                            <div class="col-3">Current: $${s.price.toFixed(2)}</div>
                            <div class="col-3 text-end ${pnl >= 0 ? 'price-up' : 'price-down'} fw-bold">$${pnl.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-muted">No holdings yet.</p>';
        }

        function renderOrders() {
            document.getElementById('openOrdersList').innerHTML = user.orders.map((o, i) => `
                <tr>
                    <td>${o.sym}</td>
                    <td><span class="badge bg-info">${o.type}</span> ${o.dir}</td>
                    <td>$${o.trigger.toFixed(2)}</td>
                    <td>${o.qty}</td>
                    <td><button class="btn btn-sm btn-link text-danger" onclick="user.orders.splice(${i},1); updateUI();">Cancel</button></td>
                </tr>
            `).join('');
        }

        function renderHistory() {
            document.getElementById('historyLog').innerHTML = user.history.slice().reverse().map(h => `
                <div class="transaction-item">
                    <div class="d-flex justify-content-between">
                        <span><strong>${h.dir.toUpperCase()} ${h.qty} ${h.sym}</strong> @ $${h.price.toFixed(2)}</span>
                        <span class="text-muted small">${h.time} (${h.type})</span>
                    </div>
                </div>
            `).join('');
        }

        function renderHeatmap() {
            document.getElementById('heatmapGrid').innerHTML = stocks.map(s => {
                const intensity = Math.min(Math.abs(s.change) * 40, 255);
                const color = s.change >= 0 ? `rgb(0, ${intensity}, 0)` : `rgb(${intensity}, 0, 0)`;
                return `<div class="heatmap-cell" style="background:${color}">${s.symbol}<br>${s.change.toFixed(1)}%</div>`;
            }).join('');
        }

        function renderSocial() {
            document.getElementById('socialFeed').innerHTML = user.posts.map(p => `
                <div class="stock-card">
                    <strong>@${p.user}</strong> <small class="text-muted float-end">${p.time}</small>
                    <p class="mb-0 mt-1">${p.text}</p>
                </div>
            `).join('');

            document.getElementById('leaderboard').innerHTML = `
                <div class="d-flex justify-content-between mb-1"><span>1. You</span> <strong>$${document.getElementById('totalBalance').innerText}</strong></div>
                <div class="d-flex justify-content-between mb-1"><span>2. TradeMaster</span> <strong>$54,200</strong></div>
                <div class="d-flex justify-content-between mb-1"><span>3. WhaleWatcher</span> <strong>$49,100</strong></div>
            `;
        }

        function addPost() {
            const txt = document.getElementById('postContent').value;
            if (!txt) return;
            user.posts.unshift({
                user: "Me",
                text: txt,
                time: "Just now"
            });
            document.getElementById('postContent').value = '';
            renderSocial();
        }

        function addNews(msg) {
            const feed = document.getElementById('newsFeed');
            const div = document.createElement('div');
            div.className = 'border-bottom py-1';
            div.innerHTML = `<span class="text-muted small">${new Date().toLocaleTimeString()}</span><br>${msg}`;
            feed.prepend(div);
            if (feed.children.length > 8) feed.lastChild.remove();
        }

        function toggleTheme() {
            const body = document.documentElement;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').innerText = isDark ? 'üåô' : '‚òÄÔ∏è';
            drawChart();
        }

        function setAlert() {
            const sym = document.getElementById('alertSym').value.toUpperCase();
            const price = parseFloat(document.getElementById('alertPrice').value);
            const type = document.getElementById('alertType').value;
            if (!sym || isNaN(price)) return;
            user.alerts.push({
                sym,
                price,
                type
            });
            updateUI();
        }

        function exportCSV() {
            let csv = "Symbol,Qty,AvgPrice\n";
            Object.keys(user.portfolio).forEach(k => {
                csv += `${k},${user.portfolio[k].qty},${user.portfolio[k].avgPrice}\n`;
            });
            const blob = new Blob([csv], {
                type: 'text/csv'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio.csv';
            a.click();
        }

        // Search Input Logic
        document.getElementById('stockSearchInput').oninput = function() {
            const val = this.value.toUpperCase();
            const dropdown = document.getElementById('searchDropdown');
            if (!val) {
                dropdown.style.display = 'none';
                return;
            }
            const matches = stocks.filter(s => s.symbol.includes(val) || s.name.toUpperCase().includes(val));
            dropdown.innerHTML = matches.map(s => `<div class="search-item" onclick="selectSearch('${s.symbol}')">${s.symbol} - ${s.name}</div>`).join('');
            dropdown.style.display = matches.length ? 'block' : 'none';
        };

        function selectSearch(sym) {
            document.getElementById('stockSearchInput').value = sym;
            document.getElementById('searchDropdown').style.display = 'none';
            activeSym = sym;
            drawChart();
            openTradeModal(sym);
        }

        function applyScreener() {
            const sector = document.getElementById('filterSector').value;
            const perf = document.getElementById('filterPerf').value;
            const filtered = stocks.filter(s => {
                if (sector !== 'All' && s.sector !== sector) return false;
                if (perf === 'gainers' && s.change <= 0) return false;
                if (perf === 'losers' && s.change >= 0) return false;
                return true;
            });
            document.getElementById('screenerResults').innerHTML = filtered.map(s => `
                <div class="col-md-4">
                    <div class="stock-card" onclick="activeSym='${s.symbol}'; drawChart();">
                        <h6>${s.name}</h6>
                        <h4 class="${s.change >= 0 ? 'price-up' : 'price-down'}">$${s.price.toFixed(2)}</h4>
                        <small>${s.sector}</small>
                    </div>
                </div>
            `).join('');
        }

        function renderCompareSelector() {
            document.getElementById('compareSelector').innerHTML = stocks.map(s => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input compare-check" type="checkbox" value="${s.symbol}" onchange="runCompare()">
                    <label class="form-check-label">${s.symbol}</label>
                </div>
            `).join('');
        }

        function runCompare() {
            const checked = Array.from(document.querySelectorAll('.compare-check:checked')).map(c => c.value);
            if (!checked.length) {
                document.getElementById('compareTable').innerHTML = '';
                return;
            }
            const data = stocks.filter(s => checked.includes(s.symbol));
            let html = `<table class="table bg-white"><thead><tr><th>Metric</th>${data.map(d=>`<th>${d.symbol}</th>`).join('')}</tr></thead><tbody>`;
            html += `<tr><td>Price</td>${data.map(d=>`<td>$${d.price.toFixed(2)}</td>`).join('')}</tr>`;
            html += `<tr><td>Change</td>${data.map(d=>`<td class="${d.change>=0?'price-up':'price-down'}">${d.change.toFixed(2)}%</td>`).join('')}</tr>`;
            html += `<tr><td>Sector</td>${data.map(d=>`<td>${d.sector}</td>`).join('')}</tr>`;
            html += `</tbody></table>`;
            document.getElementById('compareTable').innerHTML = html;
        }

        // Global Shortcuts
        window.onkeydown = (e) => {
            if(e.key.toLowerCase() === 'b') openTradeModal(activeSym);
            if(e.key.toLowerCase() === 'd') showSection('dashboard');
        };
    </script>
</body>

</html>